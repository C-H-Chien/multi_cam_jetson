if(NOT CMAKE_SOURCE_DIR STREQUAL PROJECT_SOURCE_DIR)
  # I am top-level project, i.e. I am not being include by another project
  cmake_minimum_required(VERSION 3.12)
  project(PopsiftDemo LANGUAGES CXX)

  option(PopSift_BOOST_USE_STATIC_LIBS "Link examples with static Boost libraries" OFF)
  option(BUILD_SHARED_LIBS "Build shared libraries" ON)

  include(GNUInstallDirs)

  set(CMAKE_POSITION_INDEPENDENT_CODE ${BUILD_SHARED_LIBS})

  set(CMAKE_RUNTIME_OUTPUT_DIRECTORY "${PROJECT_BINARY_DIR}/${CMAKE_SYSTEM_NAME}-${CMAKE_SYSTEM_PROCESSOR}")
  set(CMAKE_LIBRARY_OUTPUT_DIRECTORY "${PROJECT_BINARY_DIR}/${CMAKE_SYSTEM_NAME}-${CMAKE_SYSTEM_PROCESSOR}")
endif()

# enable -fPIE for executables when -fpic
# https://cmake.org/cmake/help/v3.17/policy/CMP0083.html
if(CMAKE_VERSION VERSION_GREATER_EQUAL 3.14)
  cmake_policy(SET CMP0083 NEW)
  include(CheckPIESupported)
  check_pie_supported()
elseif(CMAKE_POSITION_INDEPENDENT_CODE AND CMAKE_CXX_COMPILER_ID STREQUAL "GNU")
  # manually add the link flag for gcc
  list(APPEND CMAKE_EXE_LINKER_FLAGS "-pie")
endif()

if(TARGET popsift)
  # when compiled in the repository the target is already defined
  add_library(PopSift::popsift ALIAS popsift)
else()
  # Add NO_CMAKE_BUILDS_PATH for windows if using CMake-GUI to build packages
  # to avoid searching in temporary build directory of Foo project
  # See 5:
  #    * http://www.cmake.org/cmake/help/v3.0/command/find_package.html
  find_package(PopSift CONFIG REQUIRED)
  message(STATUS "Found PopSift, version: ${PopSift_VERSION}")
endif()

find_package(DevIL COMPONENTS IL ILU) # yields IL_FOUND, IL_LIBRARIES, IL_INCLUDE_DIR
find_package(OpenCV QUIET) # yields OpenCV_FOUND, OpenCV_LIBS, OpenCV_INCLUDE_DIRS

# for newer CMake versions and Boost 1.70 or newer must use Boost's make file
if(CMAKE_VERSION VERSION_GREATER_EQUAL 3.30)
  cmake_policy(SET CMP0167 NEW)
endif()
if(PopSift_BOOST_USE_STATIC_LIBS)
  set(Boost_USE_STATIC_LIBS ON)
endif()
find_package(Boost 1.71.0 REQUIRED COMPONENTS filesystem program_options system)
if(WIN32)
  add_definitions("-DBOOST_ALL_NO_LIB")
endif(WIN32)

set(PD_INCLUDE_DIRS    ${Boost_INCLUDE_DIRS})
set(PD_LINK_LIBS       ${Boost_LIBRARIES} ${CUDA_CUDADEVRT_LIBRARY})

# Image loading priority: DevIL > OpenCV > PGM
if(IL_FOUND OR DevIL_FOUND)
  message(STATUS "DevIL found - using DevIL for image loading")
  set(PD_COMPILE_OPTIONS "-DUSE_DEVIL")
  list(APPEND PD_INCLUDE_DIRS ${IL_INCLUDE_DIR})
  list(APPEND PD_LINK_LIBS    ${IL_LIBRARIES} ${ILU_LIBRARIES})
elseif(OpenCV_FOUND)
  message(STATUS "DevIL not found, but OpenCV found - using OpenCV for image loading")
  set(PD_COMPILE_OPTIONS "-DUSE_OPENCV")
  list(APPEND PD_INCLUDE_DIRS ${OpenCV_INCLUDE_DIRS})
  list(APPEND PD_LINK_LIBS    ${OpenCV_LIBS})
else()
  message(WARNING "Neither DevIL nor OpenCV found -- Falling back to pgmread")
  set(PD_COMPILE_OPTIONS "" )
endif()

#############################################################
# popsift-demo
#############################################################

add_executable(popsift-demo  main.cpp pgmread.cpp pgmread.h)

set_property(TARGET popsift-demo PROPERTY CXX_STANDARD 11)

target_compile_options(popsift-demo PRIVATE ${PD_COMPILE_OPTIONS} )
target_include_directories(popsift-demo PUBLIC PopSift::popsift ${PD_INCLUDE_DIRS})
target_compile_definitions(popsift-demo PRIVATE ${Boost_DEFINITIONS})
target_link_libraries(popsift-demo PUBLIC PopSift::popsift ${PD_LINK_LIBS})


#############################################################
# popsift-match
#############################################################

add_executable(popsift-match match.cpp pgmread.cpp pgmread.h)

set_property(TARGET popsift-match PROPERTY CXX_STANDARD 11)

target_compile_options(popsift-match PRIVATE ${PD_COMPILE_OPTIONS} )
target_include_directories(popsift-match PUBLIC PopSift::popsift ${PD_INCLUDE_DIRS})
target_compile_definitions(popsift-match PRIVATE ${Boost_DEFINITIONS})
target_link_libraries(popsift-match PUBLIC PopSift::popsift ${PD_LINK_LIBS})

#############################################################
# Python bindings
#############################################################

if(PopSift_BUILD_PYTHON_BINDINGS)
  # Find required packages for Python bindings
  find_package(Python3 COMPONENTS Interpreter Development REQUIRED)
  find_package(pybind11 REQUIRED)
  
  message(STATUS "Building Python bindings...")
  message(STATUS "Python executable: ${Python3_EXECUTABLE}")
  message(STATUS "Python version: ${Python3_VERSION}")
  message(STATUS "pybind11 version: ${pybind11_VERSION}")
  
  # Create Python extension for SIFT configuration (shared)
  pybind11_add_module(popsift_config py_sift_config.cpp sift_config_python.cpp)
  
  # Link libraries for SIFT configuration
  target_link_libraries(popsift_config PRIVATE 
      PopSift::popsift
      ${PD_LINK_LIBS}
  )
  
  # Set include directories for SIFT configuration
  target_include_directories(popsift_config PRIVATE
      ${CMAKE_CURRENT_SOURCE_DIR}/..
      ${CMAKE_CURRENT_SOURCE_DIR}/../../generated
      ${Python3_INCLUDE_DIRS}
      ${PD_INCLUDE_DIRS}
  )
  
  # Set compile options and definitions
  target_compile_options(popsift_config PRIVATE ${PD_COMPILE_OPTIONS})
  target_compile_definitions(popsift_config PRIVATE ${Boost_DEFINITIONS})
  
  # Set C++ standard to match main project
  set_target_properties(popsift_config PROPERTIES
      CXX_STANDARD ${PopSift_CXX_STANDARD}
      CXX_STANDARD_REQUIRED ON
  )

  # Create Python extension for feature extraction
  pybind11_add_module(popsift_extract py_main.cpp pgmread.cpp sift_config_python.cpp)
  
  # Link libraries for feature extraction
  target_link_libraries(popsift_extract PRIVATE 
      PopSift::popsift
      CUDA::cudart
      CUDA::curand
      ${PD_LINK_LIBS}
  )
  
  # Set include directories for feature extraction
  target_include_directories(popsift_extract PRIVATE
      ${CMAKE_CURRENT_SOURCE_DIR}/..
      ${CMAKE_CURRENT_SOURCE_DIR}/../../generated
      ${Python3_INCLUDE_DIRS}
      ${PD_INCLUDE_DIRS}
  )
  
  # Set compile options and definitions
  target_compile_options(popsift_extract PRIVATE ${PD_COMPILE_OPTIONS})
  target_compile_definitions(popsift_extract PRIVATE ${Boost_DEFINITIONS})
  
  # Set C++ standard to match main project
  set_target_properties(popsift_extract PROPERTIES
      CXX_STANDARD ${PopSift_CXX_STANDARD}
      CXX_STANDARD_REQUIRED ON
  )
  
  # Create Python extension for feature matching
  pybind11_add_module(popsift_match py_match.cpp pgmread.cpp sift_config_python.cpp)
  
  # Link libraries for feature matching
  target_link_libraries(popsift_match PRIVATE 
      PopSift::popsift
      CUDA::cudart
      CUDA::curand
      ${PD_LINK_LIBS}
  )
  
  # Set include directories for feature matching
  target_include_directories(popsift_match PRIVATE
      ${CMAKE_CURRENT_SOURCE_DIR}/..
      ${CMAKE_CURRENT_SOURCE_DIR}/../../generated
      ${Python3_INCLUDE_DIRS}
      ${PD_INCLUDE_DIRS}
  )
  
  # Set compile options and definitions
  target_compile_options(popsift_match PRIVATE ${PD_COMPILE_OPTIONS})
  target_compile_definitions(popsift_match PRIVATE ${Boost_DEFINITIONS})
  
  # Set C++ standard to match main project
  set_target_properties(popsift_match PROPERTIES
      CXX_STANDARD ${PopSift_CXX_STANDARD}
      CXX_STANDARD_REQUIRED ON
  )
  
  # Installation for Python modules
  install(TARGETS popsift_config popsift_extract popsift_match
      COMPONENT python
      LIBRARY DESTINATION ${CMAKE_INSTALL_PREFIX}/python
  )
endif()

#############################################################
# installation
#############################################################

install(TARGETS popsift-demo DESTINATION ${CMAKE_INSTALL_BINDIR})
